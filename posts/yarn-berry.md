---
title: node_modules를 지워라, Yarn Berry
date: "2022-04-13"
description: "Yarn Berry에 대해 알아보고 적용해보기."
tags: ["Yarn", "Yarn Berry", "node_modules", "dependencies"]
thumbnail: "yarn-berry.png"
---

# 들어가며 🏃

---

이번 포스팅은 Yarn의 두 번째 버전에 해당하는 **_Yarn Berry_**에 대해서 다뤄볼 예정입니다. 이전에 회사 동료분을 통해 알았던 내용이었는데, 이번에 **사내 프로젝트 중 하나에 적용해볼 기회가 생겨** 이를 즉각적으로 적용하게 되었습니다. 그래서 해당 포스팅은 **이에 대한 후기**와 비슷한 내용이 될 것 같습니다.

워낙 다른 포스팅들에 설명이 잘 되어 있어 대부분의 내용들이 링크로 생략될 예정입니다. 워낙 잘 정리해놓으신 내용들을 **다시금 재가공해서 올리는 것보다 해당 포스팅을 다시금 보는 것이 더 도움이 될 것 같아** 그렇게 하기로 했습니다. 물론, **간단한 요약** 정도는 진행할 예정입니다.

# Yarn Berry, 넌 누구냐 🐈‍⬛

---

Yarn Berry를 사용하기 위해선 **Yarn Berry가 무엇인지, 왜 등장했는지에 대한 내용**을 간단히 알아볼 필요가 있습니다. 앞에서 말씀드렸다시피 **관련 링크의 언급과 간단한 요약**을 진행하도록 하겠습니다.

> **관련 링크 🔖**
>
> [🔗 Plug'n'Play : Yarn](https://yarnpkg.com/features/pnp)
>
> [🔗 node_modules로부터 우리를 구원해 줄 Yarn Berry : Tosstech](https://toss.tech/article/node-modules-and-yarn-berry)

앞의 포스팅은 **Yarn 공식 문서 내 Plug'n'Play에 대한 내용**이고 **기존 `node_modules` 가 갖는 문제점**과 이에 대한 **해결 방안**에 관한 내용들이 포함되어있습니다. 해당 부분에 대해 간단히 요약하자면 다음과 같습니다.

## node_modules가 갖는 문제점

---

`yarn install` 을 실행할 때 Yarn은 **`node_modules` 디렉토리를 생성**하고 내장된 [Node Resolution Algorithm](https://nodejs.org/api/modules.html#modules_loading_from_node_modules_folders)을 통해 사용할 수 있습니다.

이러한 맥락에서 **파일 기준으로만 추론**하고, 파일 유무를 따져가며 계속해서 탐색을 진행하는 프로세스를 거쳤고, 이런 부분은 다음과 같은 이유로 **비효율적**이라고 판단되었습니다.

- `node_modules` 디렉토리 내에는 일반적으로 엄청난 양의 파일이 포함됩니다. 또한 기존 설치가 저장된 상태로 진행되지 않기 때문에, **이를 생성하는 것이 `yarn install` 실행의 70% 이상을 차지하게 되는 결과**를 야기했습니다.
- `node_modules` 생성은 **I/O(Input/Output)가 많은 작업**이었기에 패키지 관리자는 단순한 파일 복사 수행 이상으로 **최적화할 수 있는 여유가 없었습니다.**
  - 디스크 조작을 위한 시스템 호출을 하기 이전에 **파일 시스템의 현재 상태를 비교해야했기 때문**입니다.
- Node는 **패키지 개념이 없었기에**, 파일에 액세스해야 하는지 여부도 알지 못했습니다.
  - 이는 `package.json` 에 의존성 하나를 기입하지 않아, 배포 이후에 갑자기 동작하지 않는 경우를 발생시키기도 합니다.
- **런타임**시에도 Node Resolution은 **모든 단일 필수 파일을 로드할 위치를 파악하기 위해 `stat` 과 `readdir` 호출을 수행**해야 했습니다.
  - 이는 낭비이며 노드 애플리케이션의 부팅 시간을 늦추는 원인 중 하나였습니다.
- `node_modules` 폴더 디자인은 **패키지 관리자가 패키지 중복을 적절하게 제거할 수 없다는 점**에서 실용적이지 않습니다.
  - 이 부분은 [위 토스테크 포스팅의 유령 의존성 부분](https://toss.tech/article/node-modules-and-yarn-berry)을 참고하시면 이해하기 쉽습니다.

## node_modules 수정

---

Yarn은 이미 의존성 트리에 대한 모든 것을 알고 있고, 심지어 디스크에 설치하기도 합니다. 그렇기에 **패키지의 위치를 파악하는 것**은 Node가 아닌 패키지 매니저가 해야하며, **인터프리터에게 디스크 내 패키지를 위치를 알리고 버전 간 의존성을 관리하는 작업을 진행**해야 합니다.

해당 설치 모드(Yarn Berry)는 일반적인 `node_modules` 대신 **다양한 패키지 복사본에 해당하는 `.pnp.cjs` 을 설치합니다.** `.pnp.cjs` 파일 내에는 다양한 맵이 포함되며, 하나는 **패키지 이름 및 버전을 디스크 내 해당 위치에 연결**하고, 다른 하나는 **패키지 이름 및 버전을 의존성 목록에 연결**합니다. 이러한 조회 테이블을 사용하여 Yarn은 **의존성 트리의 일부**이고 해당 파일이 환경 내에서 로드되는 한 **액세스해야 할 패키지 위치를 Node에 즉시 알릴 수 있습니다.**

이런 방식엔 다음과 같은 이점이 있습니다.

- 이제 **설치가 거의 즉시 이루어집니다.** Yarn은 **단일 텍스트 파일**을 생성하기만 하면 됩니다.
  - 주요 병목 현상은 디스크 성능 보다는 **프로젝트 의존성 수**가 이에 해당합니다.
- **감소된 I/O 작업으로 설치가 더 안정적**입니다.
- **의존성 트리의 완벽한 최적화**와 **예측 가능한 패키지의 인스턴스화**가 가능해집니다.
- 생성된 `.pnp.cjs` 파일은 **Zero-installs**을 통해 작은 노력으로 레포지토리에 커밋이 가능하여 **`yarn install` 을 실행할 필요가 없습니다.**
- 노드 확인은 이전만큼 파일 시스템 반복을 할 필요가 없습니다!

두 번째 포스팅은 그 상태로 요약이 잘 되어있다고 판단되어 생략하겠습니다.

# Yarn Berry 적용하기! ⚙️

---

앞에서 말씀드렸다시피 사내 프로젝트에 적용하게 될 기회가 생겨서 **마이그레이션** 위주의 과정으로 진행하도록 하겠습니다.

우선 프로젝트에 `yarn berry` 버전의 셋팅을 시작합니다.

```sh
yarn set version berry
```

이후 기존 `node_modules` 파일을 제거하고, `.pnp.js` 파일이 생성된 것을 확인할 수 있습니다.

> 놀랍게도 이렇게 하면 끝입니다

라고 말하고 싶지만 `yarn berry` 로 버전을 변경하면 발생하는 이슈들이 몇 가지 존재합니다.

# 설치 관련 이슈 ❕

---

제가 경험했던 몇 가지 **설치 도중 발생한 이슈**를 정리해보려고 합니다.

## Editor SDKs

---

분명히 `prettier` 관련 파일이 존재하고 패키지 설치도 정상적으로 되어 있는데, 적용하고 난 이후 혹은 해당 레포지토리를 클론 받으면 **`prettier` 나 타입스크립트가 작동하지 않는 오류**가 생기면서 다음의 오류를 보여줍니다.

![error](/images/posts/yarn-berry/sdks-error.png)

해당 이슈는 현재 사용하는 **에디터와 관련된 이슈**로서 `yarn berry` 로 변경하고 나면 **에디터에 대한 셋팅을 별도로 해줘야 합니다.** 다음의 명령어를 입력하여 이를 해결할 수 있습니다.

```sh
yarn dlx @yarnpkg/sdks
```

자세한 내용은 [해당 링크](https://yarnpkg.com/getting-started/editor-sdks)를 참고해주세요.

## 타입스크립트 플러그인

---

타입스크립트 셋팅을 위한 하나의 과정이 더 있는데요, **플러그인을 설치하는 것**이 그렇습니다.

해당 플러그인의 역할은 자체 타입을 포함하지 않는 패키지를 추가할 때, **`@types/` 패키지들을 `package.json` 폴더에 의존성으로 자동으로 추가해준다**고 합니다.

다음의 명령어를 통해 타입스크립트 플러그인 설치가 가능합니다.

```sh
yarn plugin import typescript
```

## 경우에 따른 `yml` 파일 수정

---

모든 패키지가 정상적으로 `yarn berry` 를 통해 실행된다면 좋겠지만, 경우에 따라 경로를 잘못 찾는 경우가 발생합니다. 이런 경우 **별도로 경로를 설정해주어야 합니다.**

제 경우엔 `lodash` 라이브러리를 별도로 설정해주었습니다.

```yml
packageExtensions:
  lodash@*:
    dependencies:
      lodash/debounce: "*"
```
